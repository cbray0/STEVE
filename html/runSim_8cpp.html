<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>STEVE (Simultaneous Thread EValuation of gEant4): runSim.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">STEVE (Simultaneous Thread EValuation of gEant4)
   </div>
   <div id="projectbrief">Workaround for multithreading singlethreaded simulations</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('runSim_8cpp.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">runSim.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Simulation automation tools repo.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="runSim_8h_source.html">runSim.h</a>&quot;</code><br/>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a3c04138a5bfe5d72780bb7e82a18e627"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="runSim_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a> (int argc, char **argv)</td></tr>
<tr class="memdesc:a3c04138a5bfe5d72780bb7e82a18e627"><td class="mdescLeft">&#160;</td><td class="mdescRight">Reads in arguments, then calls <a class="el" href="namespacesimulation.html#a4e74f232951e017de356f58e9e977161" title="Runs the multithreading workaround. Exists so that it can be easily called from another program...">runSim()</a>  <a href="#a3c04138a5bfe5d72780bb7e82a18e627">More...</a><br/></td></tr>
<tr class="separator:a3c04138a5bfe5d72780bb7e82a18e627"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Simulation automation tools repo. </p>
<dl class="section author"><dt>Author</dt><dd>Connor Bray</dd></dl>
<dl class="section date"><dt>Date</dt><dd>28 Feb. 2018</dd></dl>
<h2>Multithreading workaround code</h2>
<h3>Arguments:</h3>
<p><code>-t threads</code> - Number of threads to run</p>
<p><code>-y</code> - Automatically cleans directory and skips directory check without user input.</p>
<p><code>--clean</code> - Supply your own clean command. If not included, default clean command is <code>rm -f *.root</code>. This can reference a file if the command executes a file.</p>
<p><code>--remove</code> - Cleans directory after simulation completion by adding .keep to the end of the output file, then running the clean function, which is by defailt <code>rm -f *.root</code>, then moving the output back to the original filename.</p>
<p><code>--regex</code> - Runs the simulation from the string provided once all instances of "%n" are replaced by the thread number. It allows for more flexibility in command execution as the singlethreaded command for any simulation (that has the two modifications described below) can easily be multithreaded. Make sure to redirect stdout and stderr to a file or /dev/null to prevent simultaneous writing to the console. Note that the string should be surrounded in quotes as to not specify additional arguments.</p>
<p><code>--output</code> - Final combined output .root filename. Defaults to <code>g4out.root</code>.</p>
<h2>Notes:</h2>
<p>The program also wans you if you are running it from a directory not inside of /home/data because of my specific use case.</p>
<p>Changes needed in simulation for runSim to work:</p>
<ol type="1">
<li>Simulation seed must pull from /dev/random Reference implementation:</li>
</ol>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line">G4int random_seed(){ <span class="comment">// Credit to posop on stackoverflow for code that I adapted. Reading an int from /dev/random is a better random seed than time(NULL) because it is cryptographically secure and protects against multiple instances loading in same second, which was a problem before.</span></div>
<div class="line">    G4int seed;</div>
<div class="line">    std::ifstream file(<span class="stringliteral">&quot;/dev/random&quot;</span>,std::ios::binary);</div>
<div class="line">    <span class="keywordflow">if</span>(file.is_open()){</div>
<div class="line">        <span class="keywordtype">char</span> *memblock;</div>
<div class="line">        G4int size=<span class="keyword">sizeof</span>(G4int);</div>
<div class="line">        memblock=<span class="keyword">new</span> <span class="keywordtype">char</span> [size];</div>
<div class="line">        file.read(memblock,size);</div>
<div class="line">        file.close();</div>
<div class="line">        seed=*<span class="keyword">reinterpret_cast&lt;</span>G4int*<span class="keyword">&gt;</span>(memblock);</div>
<div class="line">        <span class="keyword">delete</span>[] memblock;</div>
<div class="line">        <span class="keywordflow">return</span> seed;</div>
<div class="line">    }<span class="keywordflow">else</span>{<span class="keywordflow">return</span> random_seed();} <span class="comment">// Continually retry until /dev/random is free</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>Then in int main</p>
<div class="fragment"><div class="line">G4int seed = random_seed();</div>
<div class="line">G4Random::setTheSeed( seed );</div>
</div><!-- fragment --><ol type="1">
<li>Simulation must take an argument to change output filename by adding characters (eg. adding the supplied string between the <code>g4out</code> and the <code>.root</code>). Note that the resulting files must still end in <code>.root</code>. Reference implmentation:</li>
</ol>
<div class="fragment"><div class="line"><span class="comment">// In main executable, eg. Griffinv10.cc</span></div>
<div class="line"><span class="comment">// In global scope:</span></div>
<div class="line">G4String file_name=<span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><span class="comment">// In argument parsing:</span></div>
<div class="line"><span class="keywordflow">if</span>(argc&gt;2) file_name=argv[2];</div>
<div class="line"><span class="comment">// In Histomanager.cc</span></div>
<div class="line"><span class="comment">// In HistoManager::HistoManager()</span></div>
<div class="line"><span class="comment">// Replacing fFileName[0] = &quot;g4out&quot;;</span></div>
<div class="line"><span class="keyword">extern</span> G4String file_name;</div>
<div class="line">fFileName[0] = <span class="stringliteral">&quot;g4out&quot;</span>+file_name;</div>
</div><!-- fragment --><h2>Building</h2>
<p>To build <a class="el" href="runSim_8cpp.html" title="Simulation automation tools repo. ">runSim.cpp</a>, use </p>
<div class="fragment"><div class="line">g++ -Wall -std=c++11 -pthread -Ofast -o <a class="code" href="namespacesimulation.html#a4e74f232951e017de356f58e9e977161">runSim</a>.o <a class="code" href="namespacesimulation.html#a4e74f232951e017de356f58e9e977161">runSim</a>.cpp</div>
</div><!-- fragment --> </div><h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a3c04138a5bfe5d72780bb7e82a18e627"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>argv</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Reads in arguments, then calls <a class="el" href="namespacesimulation.html#a4e74f232951e017de356f58e9e977161" title="Runs the multithreading workaround. Exists so that it can be easily called from another program...">runSim()</a> </p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="runSim_8cpp.html">runSim.cpp</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
