<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>STEVE (Simultaneous Thread EValuation of gEant4): runSim2.0.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">STEVE (Simultaneous Thread EValuation of gEant4)
   </div>
   <div id="projectbrief">Workaround for multithreading singlethreaded simulations</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('runSim2_80_8cpp.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">runSim2.0.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;string&gt;</code><br/>
<code>#include &lt;iostream&gt;</code><br/>
<code>#include &lt;thread&gt;</code><br/>
<code>#include &lt;vector&gt;</code><br/>
<code>#include &lt;mutex&gt;</code><br/>
<code>#include &lt;ctime&gt;</code><br/>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a77f79fe88017c77fe691dca577d3fe49"><td class="memItemLeft" align="right" valign="top">std::string&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="runSim2_80_8cpp.html#a77f79fe88017c77fe691dca577d3fe49">ReplaceString</a> (std::string subject, const std::string &amp;search, const std::string &amp;replace)</td></tr>
<tr class="separator:a77f79fe88017c77fe691dca577d3fe49"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a852ffc8e202d83924bcf66a38a5cac22"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="runSim2_80_8cpp.html#a852ffc8e202d83924bcf66a38a5cac22">regexReplace</a> (string &amp;input, const string threadnumber=&quot;&quot;)</td></tr>
<tr class="separator:a852ffc8e202d83924bcf66a38a5cac22"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a55ec0c0df95b1118b42d75ecc3709e81"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="runSim2_80_8cpp.html#a55ec0c0df95b1118b42d75ecc3709e81">runSimRegex</a> (string regex, string num)</td></tr>
<tr class="separator:a55ec0c0df95b1118b42d75ecc3709e81"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6823e8f7404dcfcb9600650017973706"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="runSim2_80_8cpp.html#a6823e8f7404dcfcb9600650017973706">clean</a> (bool autoClean=0)</td></tr>
<tr class="separator:a6823e8f7404dcfcb9600650017973706"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3c04138a5bfe5d72780bb7e82a18e627"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="runSim2_80_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a> (int argc, char **argv)</td></tr>
<tr class="separator:a3c04138a5bfe5d72780bb7e82a18e627"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:af02de9b1df13f8af2bb6abe194f5c69c"><td class="memItemLeft" align="right" valign="top">mutex&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="runSim2_80_8cpp.html#af02de9b1df13f8af2bb6abe194f5c69c">printing</a></td></tr>
<tr class="memdesc:af02de9b1df13f8af2bb6abe194f5c69c"><td class="mdescLeft">&#160;</td><td class="mdescRight">To prevent multiple threads from using stdout at the same time.  <a href="#af02de9b1df13f8af2bb6abe194f5c69c">More...</a><br/></td></tr>
<tr class="separator:af02de9b1df13f8af2bb6abe194f5c69c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a6823e8f7404dcfcb9600650017973706"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool clean </td>
          <td>(</td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>autoClean</em> = <code>0</code></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>Clean the current directory</h2>
<h3>Arguments:</h3>
<p><code>bool autoClean</code> - Bool of whether or not to automatically clean the directory. It defualts to zero, which will prompt the user first, but if set to one the program cleans the directory without outside input.</p>
<h3>Notes:</h3>
<p>Ensures there are no files matching g4out*.root in the current directory. If there are, it offers to automatically remove them, or to exit the program to allow the user to save and remove them manually. Also note that this assumes that all output files end in <code>.root</code>, and no other files end in <code>.root</code>. If you want to preserve these files, you should move them to a differnt directory or change their filename (as an example, <code>g4out.root</code>-&gt;<code>g4out.root.keep</code>). </p>

<p>Referenced by <a class="el" href="runSim2_80_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main()</a>.</p>

</div>
</div>
<a class="anchor" id="a3c04138a5bfe5d72780bb7e82a18e627"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>argv</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>Multithreading workaround</h2>
<h3>Arguments:</h3>
<p><code>-t threads</code> - Number of threads to run</p>
<p><code>-y</code> - Automatically cleans directory without user input.</p>
<p><code>--clean</code> - Automatically cleans directory after simulation completion, leaving only the combined output file instead of the induvidual <code>.root</code> files from each thread. Note, this removes all .root files except for the final output file, so do not use if you wish to preserve other <code>.root</code> files in the directory. Instead, with knowledge of how your induvidual thread files are named, run an rm command after runSim.o to clean up.</p>
<p><code>--regex</code> - Runs the simulation from the string provided once all instances of "%n" are replaced by the thread number. It allows for more flexibility in command execution as the singlethreaded command for any simulation (that has the two modifications described below) can easily be multithreaded. Make sure to redirect stdout and stderr to a file or /dev/null to prevent simultaneous writing to the console. Note that the string should be surrounded in quotes as to not specify additional arguments.</p>
<p><code>--output</code> - Final combined output .root filename. Defaults to <code>g4out.root</code>.</p>
<p><code>--test</code> - Internal testing flag. Currently unused.</p>
<h2>Notes:</h2>
<p>Changes needed in simulation for runSim to work:</p>
<ol type="1">
<li>Simulation seed must pull from /dev/random Reference implementation:</li>
</ol>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line">G4int random_seed(){ <span class="comment">// Credit to posop on stackoverflow for code that I adapted. Reading an int from /dev/random is a better random seed than time(NULL) because it is cryptographically secure and protects against multiple instances loading in same second, which was a problem before.</span></div>
<div class="line">    G4int seed;</div>
<div class="line">    std::ifstream file(<span class="stringliteral">&quot;/dev/random&quot;</span>,std::ios::binary);</div>
<div class="line">    <span class="keywordflow">if</span>(file.is_open()){</div>
<div class="line">        <span class="keywordtype">char</span> *memblock;</div>
<div class="line">        G4int size=<span class="keyword">sizeof</span>(G4int);</div>
<div class="line">        memblock=<span class="keyword">new</span> <span class="keywordtype">char</span> [size];</div>
<div class="line">        file.read(memblock,size);</div>
<div class="line">        file.close();</div>
<div class="line">        seed=*<span class="keyword">reinterpret_cast&lt;</span>G4int*<span class="keyword">&gt;</span>(memblock);</div>
<div class="line">        <span class="keyword">delete</span>[] memblock;</div>
<div class="line">        <span class="keywordflow">return</span> seed;</div>
<div class="line">    }<span class="keywordflow">else</span>{<span class="keywordflow">return</span> random_seed();} <span class="comment">// Continually retry until /dev/random is free</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>Then in int main</p>
<div class="fragment"><div class="line">G4int seed = random_seed();</div>
<div class="line">G4Random::setTheSeed( seed );</div>
</div><!-- fragment --><ol type="1">
<li>Simulation must take an argument to change output filename by adding characters (eg. adding the supplied string between the <code>g4out</code> and the <code>.root</code>). Note that the resulting files must still end in <code>.root</code>. Reference implmentation:</li>
</ol>
<div class="fragment"><div class="line"><span class="comment">// In main executable, eg. Griffinv10.cc</span></div>
<div class="line"><span class="comment">// In global scope:</span></div>
<div class="line">G4String file_name=<span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><span class="comment">// In argument parsing:</span></div>
<div class="line"><span class="keywordflow">if</span>(argc&gt;2) file_name=argv[2];</div>
<div class="line"><span class="comment">// In Histomanager.cc</span></div>
<div class="line"><span class="comment">// In HistoManager::HistoManager()</span></div>
<div class="line"><span class="comment">// Replacing fFileName[0] = &quot;g4out&quot;;</span></div>
<div class="line"><span class="keyword">extern</span> G4String file_name;</div>
<div class="line">fFileName[0] = <span class="stringliteral">&quot;g4out&quot;</span>+file_name;</div>
</div><!-- fragment --><h2>Building</h2>
<p>To build runSim.cpp, use </p>
<div class="fragment"><div class="line">g++ -Wall -std=c++11 -pthread -Ofast -o runSim.o runSim.cpp</div>
</div><!-- fragment --> 
</div>
</div>
<a class="anchor" id="a852ffc8e202d83924bcf66a38a5cac22"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void regexReplace </td>
          <td>(</td>
          <td class="paramtype">string &amp;&#160;</td>
          <td class="paramname"><em>input</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const string&#160;</td>
          <td class="paramname"><em>threadnumber</em> = <code>&quot;&quot;</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>Apply regex transformations to input string.</h2>
<h1>Arguments:</h1>
<p><code>string&amp; input</code> - Input string reference to modify in place.</p>
<p><code>const string threadnumber</code> - Threadnumber string to replace n with. Only valid for threads, so it defaults to "".</p>
<h1>Transformations:</h1>
<p>"%d" -&gt; date</p>
<p>"%t" -&gt; time</p>
<p>"%u" -&gt; unix time</p>
<p>"%n" -&gt; thread number </p>

<p>Referenced by <a class="el" href="runSim2_80_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main()</a>, and <a class="el" href="runSim2_80_8cpp.html#a55ec0c0df95b1118b42d75ecc3709e81">runSimRegex()</a>.</p>

</div>
</div>
<a class="anchor" id="a77f79fe88017c77fe691dca577d3fe49"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::string ReplaceString </td>
          <td>(</td>
          <td class="paramtype">std::string&#160;</td>
          <td class="paramname"><em>subject</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>search</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>replace</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>Replace all instances of a string in another string with a third string. Credit to Czarek Tomczak on stack overflow for supplying the code in response to a question asked by NullVoxPopuli.</h2>

<p>Referenced by <a class="el" href="runSim2_80_8cpp.html#a852ffc8e202d83924bcf66a38a5cac22">regexReplace()</a>.</p>

</div>
</div>
<a class="anchor" id="a55ec0c0df95b1118b42d75ecc3709e81"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void runSimRegex </td>
          <td>(</td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>regex</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>num</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<h2>Run a thread of the simulation</h2>
<h3>Arguments:</h3>
<p><code>string regex</code> - Command to run for each string, where every instance of "%n" will be replaced with the thread number.</p>
<p><code>string num</code> - Thread number </p>

<p>Referenced by <a class="el" href="runSim2_80_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main()</a>.</p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a class="anchor" id="af02de9b1df13f8af2bb6abe194f5c69c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">mutex printing</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>To prevent multiple threads from using stdout at the same time. </p>

<p>Referenced by <a class="el" href="runSim2_80_8cpp.html#a55ec0c0df95b1118b42d75ecc3709e81">runSimRegex()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="runSim2_80_8cpp.html">runSim2.0.cpp</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
